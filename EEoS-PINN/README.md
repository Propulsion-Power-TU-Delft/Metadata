# Consistent, data-driven fluid model for NICFD using physics-informed machine learning

This folder contains the scripts and configurations used for the study of "Consistent, data-driven fluid model for NICFD using physics-informed machine learning". The scripts used to generate the fluid data and define the data-driven fluid models are in the current folder, while the scripts used for post-processing of the data and the generation of images are in the folder [PostProcessing](./PostProcessing/). 

The fluid data and neural networks in this study were generated using [SU2 DataMiner](https://github.com/EvertBunschoten/SU2_DataMiner). This file explains the process used to re-produce the results of the study.

## Step 0: Requirements and set-up 

All steps for generating the fluid data, training the neural networks, and running the CFD calculations are presented as python scripts. 

SU2 DataMiner can be used by downloading the [source code](https://github.com/EvertBunschoten/SU2_DataMiner) and exporting the environment variables listed in the documentation. 

In order to reproduce the simulation results in this study, an installation of [SU2](https://github.com/su2code/SU2.git) version 8.1.0 "Harrier" or newer is required. 

The network outputs for the first-order and second-order derivatives of entropy with respect to density need to be transformed when usin the MTNN as described in the manuscript. This transformation is not available in the public version of the source code and should be added manually. The transformation of the first-order and second-order derivatives of entropy with respect to density is enabled by adding the following code snippet
```
if (!use_MLP_derivatives) {
    dsdrho_e = -exp(dsdrho_e);
    d2sdrho2 = exp(d2sdrho2);
}
```
after line 318 in the file ```SU2_CFD/src/fluid/CDataDrivenFluid.cpp``` of the SU2 source code. 

SU2 should be built with the flags ```-Denable-mlpcpp=true -Denable-coolprop=true -Denable-pywrapper=true``` in order to enable the PINN funcationality for the data-driven fluid model and use the multi-parameter equation of state in SU2.

## Step 1: SU2 DataMiner configurations

The first step is to generate the SU2 DataMiner configurations which contain all the information for generating the fluid data and training the neural networks. The configruations are generated by running
```
python3 0\:generate_config.py
```
This will generate three files named ```Direct_low.cfg, Direct_high.cfg```, and ```PINN.cfg``` and create two folders named ```Direct``` and ```PhysicsInformed``` under which fluid data will be stored and the progress of the training can be tracked from.

## Step 2: Generate fluid data

The configurations generated in step 1 are used to generate the fluid data that are used to train the two MTNNs and the PINN. The fluid data are generated using SU2 DataMiner by running 
```
python3 1\:generate_fluid_data.py 
```
The fluid data are stored under the folders ```Direct``` and ```PhysicsInformed``` as ```.csv``` files. The storage size of the complete data set is approximately 450 MB.

## Step 3: Train MT-NNs

The two MTNNs described in the manuscript are trained by running 
```
python3 2\:train_MLP_segregated.py
```
Each network is trained for 1000 epochs using data-fitting for the fluid entropy and the first- and second-order derivatives of the fluid entropy with respect to density and internal energy.

Progress of the training process is displayed in the terminal and are logged in the folders ```Direct/Worker_0/Model_0``` and ```Direct/Worker_0/Model_1```. Here, plots of the training convergence process are updated every 10 epochs.

## Step 4: Train PINN

The PINN used by the EEoS-PINN model in SU2 is trained by running 
```
python3 3\:train_MLP_PINN.py
```
The network is at first trained for 1000 epochs using data-fitting for the fluid entropy, after which the physics-informed machine learning process is initiated. 

Progress of the training process is displayed in the terminal and is logged in the folder ```PhysicsInformed/Worker_0/Model_0```. Here, plots of the training convergence process are updated every 10 epochs, as well as visualizations of the fluid thermodynamic state according to the EEoS-PINN and reference data. 


## Step 5: Run SU2 simulation

The calculations of the flow through the ORCHID linear cascade are performed using the python wrapper of SU2. 

The flow calculations for the EEoS-PINN, EEoS-MTNN, and CEoS are run sequentially with
```
cd SU2_Simulations
mpirun -n <NP> python3 4\:ORCHID_stator_simulation.py
```
where ```<NP>``` is the number of cores to use for running SU2. The HEoS fluid model is currently not supported by the python wrapper of SU2, so in order to run the flow calculation using the HEoS fluid model, SU2 should be run directly using
```
mpirun -n <NP> SU2_CFD config_HEoS_firstorder.cfg && mpirun -n <NP> SU2_CFD config_HEoS_secondorder.cfg
```

For each thermodynamic model, a flow calculation is run for 1000 iterations using the first-order accurate ROE convective numerical method. The calculation is then re-started and run for 20000 iterations using the second-order accurate JST convective scheme. The solution of each calculation is updated every 20 iterations and is stored in ```.vtm``` format which can be loaded in [ParaView](https://www.paraview.org/) for post-processing.